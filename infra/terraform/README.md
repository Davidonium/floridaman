# Terraform


## tfenv
tfenv is recommended to install terraform, as there's a `.terraform-version` file that will pick ip the correct terraform version to use.

Installation instructions: [https://github.com/tfutils/tfenv]()

Terraform scripts create the necessary resources to have a working instance in amazon lightsail with its own domain name.


## Bootstrap

First use `tfenv` to use the correct terraform version:
```bash
tfenv install
tfenv use
```

A `terraform.tfvars` file is needed, a template `terraform.tfvars.dist` is provided. Copy it and fill it with the desired values.

```bash
cp terraform.tfvars.dist terraform.tfvars
```

### GPG setup

A gpg key is needed in the `terraform.tfvars` file in order to encrypt the private key generated by lightsail to ssh into the machine.

The most understandable tutorial on how to install gpg and generate a key can be found in github: 
- https://docs.github.com/en/authentication/managing-commit-signature-verification/generating-a-new-gpg-key

After generating the key, retrieve it using:

```bash
# list the keys on your machine, find the one you generated, under the "sec" section
gpg --list-secret-keys --keyid-format=long

# export it for use, encoded as base64 which is undocumented in the terraform provider
# IMPORTANT that the key must NOT contain the typical BEGIN / END headers.
gpg --export <keyid> | base64
```

Copy the base64 encoded public key and paste it in the `pgp_key` variable inside `terraform.tfvars`.

## Apply and output

To create aws lightsail instance with its own dns zone (this has consequences on monthly billing in aws)
```bash
# plan first to see the changes
terraform plan

# apply the changes into aws
terraform apply -auto-approve
```

This will make the instance available through ssh
```bash
# the private key needs to be decoded from base64 and be decrypted using gpg with the same key provided for "pgp_key" tfvar
terraform output private_key | base64 -D | gpg --decrypt --input - > ~/.ssh/id_floridaman
# make the permissions of the private key secure
chmod 600 ~/.ssh/id_floridaman 
terraform output pub_key > ~/.ssh/id_floridaman.pub
terraform output ssh_config >> ~/.ssh/config
```

You should now be able to ssh into the created instance using:

```bash
ssh floridaman
```